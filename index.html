<!DOCTYPE html>
<html>
<head>
   <title>Stellar Force</title>
   <style>
      @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
   </style>

   <script src="animacao.js"></script>
   <script src="teclado.js"></script>
   <script src="colisor.js"></script> <script src="fundo.js"></script>
   <script src="spritesheet.js"></script>
   <script src="nave.js"></script>
   <script src="tiro.js"></script>
   <script src="explosao.js"></script>
   <script src="painel.js"></script>
   <script src="upvida.js"></script> <script src="ovni.js"></script>
   <script src="menu.js"></script>
   <script src="tela-info.js"></script> <style>
      html, body {
         height: 100%; margin: 0; padding: 0; font-family: sans-serif; overflow: hidden; 
      }
      body {
         background-color: #111; color: white; display: flex;
         justify-content: center; align-items: center; text-align: center;
      }
      #game-container { position: relative; width: 600px; }
      /* Adiciona o cursor de clique */
      #canvas_animacao { border: 1px solid #444; border-radius: 10px; cursor: pointer; }
      #link_jogar, #postar_pontuacao { display: none; }
   </style>
</head>
<body>
   <canvas id="canvas_animacao" width="600" height="600"></canvas>
   <script>
      var canvas = document.getElementById('canvas_animacao');
      var context = canvas.getContext('2d');

      // --- OUVINTE DE CLIQUE PARA "CLIQUE PARA INICIAR" ---
      var loadingCompleto = false; 
      canvas.addEventListener('click', function() {
         // Se o carregamento terminou E o jogo ainda não começou
         if (loadingCompleto && !gameState) { 
            iniciarMenu();
         }
      });
      
      var imagens, animacao, teclado, colisor, nave, criadorInimigos;
      var espaco, estrelas, painel;
      var musicaAcao, musicaMenu; 
      var gameState;
      var menu;
      var totalImagens = 0, carregadas = 0;
      var nivel2Ativado = false;
      var nivel3Ativado = false;

      carregarImagens();
      carregarMusicas();

      function carregarImagens() {
         // Imagens do seu 'index.html'
         imagens = {
            espaco: 'fundo-espaco.png',
            estrelas: 'fundo-estrelas.png',
            nave: 'nave-spritesheet.png',
            ovni: 'ovni.png',
            tanque: 'naveT.png',
            explosao: 'explosao.png',
            upvida: 'coracao.png',
            controles: 'teclado-controles.png',
         };
         for (var i in imagens) {
            var img = new Image();
            img.src = 'img/' + imagens[i];
            img.onload = carregando;
            totalImagens++;
            imagens[i] = img;
         }
      }

      function carregarMusicas() {
         musicaAcao = new Audio();
         musicaAcao.src = 'snd/musica-acao.mp3';
         musicaAcao.load();
         musicaAcao.volume = 0.8;
         musicaAcao.loop = true;
         
         musicaMenu = new Audio();
         musicaMenu.src = 'snd/musica-menu.mp3'; // (Adicione este arquivo!)
         musicaMenu.load();
         musicaMenu.volume = 0.5;
         musicaMenu.loop = true;
      }

      function carregando() {
         context.save();
         context.fillStyle = 'black';
         context.fillRect(0, 0, canvas.width, canvas.height);
         context.fillStyle = 'white';
         context.strokeStyle = 'black';
         context.font = '40px "Press Start 2P", monospace';
         context.textAlign = 'center';
         var xCentro = canvas.width / 2;
         context.fillText("Carregando...", xCentro, canvas.height / 2 - 20);
         context.strokeText("Carregando...", xCentro, canvas.height / 2 - 20);
         carregadas++;
         var tamanhoTotal = 300;
         var tamanho = carregadas / totalImagens * tamanhoTotal;
         context.fillStyle = 'yellow';
         var xBarra = (canvas.width - tamanhoTotal) / 2;
         context.fillRect(xBarra, canvas.height / 2 + 10, tamanho, 50);
         context.restore();

         // QUANDO TERMINAR DE CARREGAR
         if (carregadas == totalImagens) {
            loadingCompleto = true; 
            
            // Desenha a tela "Clique para Iniciar"
            context.clearRect(0, 0, canvas.width, canvas.height);
            var img = imagens.espaco;
            if (img && img.height > 0) {
               var h = img.height * (canvas.width / img.width);
               var y = h - canvas.height;
               if (y < 0) y = 0;
               context.drawImage(img, 0, -y, canvas.width, h);
            }
            context.save();
            context.font = '40px "Press Start 2P", monospace';
            context.fillStyle = 'white';
            context.textAlign = 'center';
            context.fillText("Jogo Carregado", canvas.width / 2, canvas.height / 2 - 20);
            context.font = '20px "Press Start 2P", monospace';
            context.fillStyle = 'yellow';
            context.fillText("Clique para Iniciar", canvas.width / 2, canvas.height / 2 + 30);
            context.restore();
         }
      }

      // Limpa tudo, menos os fundos
      function limparSpritesDinamicos() {
         if (!animacao) return; 
         for (var i in animacao.sprites) {
            var sprite = animacao.sprites[i];
            if (sprite !== espaco && sprite !== estrelas) {
               animacao.excluirSprite(sprite);
               if (sprite.colisor) {
                  colisor.excluirSprite(sprite);
               }
            }
         }
         if (animacao.processamentos) { 
            for (var i in animacao.processamentos) {
               animacao.excluirProcessamento(animacao.processamentos[i]);
            }
         }
         animacao.processarExclusoes();
      }
      
      function iniciarMenu() {
         gameState = 'menu';
         
         // Inicia os objetos (se for a primeira vez)
         if (!animacao) {
            animacao = new Animacao(context);
            teclado = new Teclado(document);
            espaco = new Fundo(context, imagens.espaco);
            estrelas = new Fundo(context, imagens.estrelas);
            animacao.novoSprite(espaco);
            animacao.novoSprite(estrelas);
            
            // Cria a nave (global)
            nave = new Nave(context, teclado, imagens.nave, imagens.explosao);
         }
         
         limparSpritesDinamicos();
         
         // Configura fundos para o menu
         espaco.velocidade = 15; 
         estrelas.velocidade = 200;
         espaco.posicaoEmenda = 0;
         estrelas.posicaoEmenda = 0;

         nave.velocidade = 0; // Desativa controle do jogador
         
         menu = new Menu(context, teclado, animacao);
         
         animacao.novoSprite(nave); // Adiciona a nave (para flutuar)
         animacao.novoSprite(menu); // Adiciona o texto do menu
         
         ativarTiro(false);
         
         musicaAcao.pause();
         musicaAcao.currentTime = 0;
         musicaMenu.play();
         
         if (!animacao.ligado) {
             animacao.ligar();
         }
      }

      function iniciarPartida() {
         gameState = 'playing';
         
         limparSpritesDinamicos();
         
         nivel2Ativado = false;

         
         espaco.imagem = imagens.espaco;
         espaco.velocidade = 80; 
         estrelas.imagem = imagens.estrelas;
         estrelas.velocidade = 650; 
         espaco.posicaoEmenda = 0;
         estrelas.posicaoEmenda = 0;
         
         colisor = new Colisor(); 
         animacao.colisor = colisor; 
         
         colisor.aoColidir = function (o1, o2) {
            if ((o1 instanceof Tiro && o2 instanceof Ovni) ||
               (o1 instanceof Ovni && o2 instanceof Tiro)) {
               painel.pontuacao += 10;
            }
            if ((o1 instanceof Tiro && o2 instanceof InimigoTanque) ||
               (o1 instanceof InimigoTanque && o2 instanceof Tiro)) {
               painel.pontuacao += 5;
            }
         }
         // --- FIM DA CORREÇÃO ---
         
         // Adiciona o colisor (antigo) aos processamentos
         animacao.novoProcessamento(colisor); 
         
         painel = new Painel(context, nave);
         animacao.painel = painel;
         painel.pontuacao = 0;
         
         nave.vidasExtras = 2; //
         nave.velocidade = 200; 
         nave.posicionar();
         nave.acabaramVidas = gameOver;
         
         animacao.novoSprite(nave);
         colisor.novoSprite(nave);
         
         criacaoInimigos(); 
         criadorInimigos.ultimoOvni = new Date().getTime();
         criadorInimigos.ultimoUpVida = 0; 
         ativarTiro(true);
         teclado.disparou(ENTER, pausarJogo); 
         
         musicaMenu.pause();
         musicaMenu.currentTime = 0;
         musicaAcao.play();
      }

      // Esta função não é mais chamada
      function configuracoesIniciais() { }

      function criacaoInimigos() {
         criadorInimigos = {
            ultimoOvni: new Date().getTime(),
            ultimoUpVida: 0, //

            processar: function () {
               var agora = new Date().getTime();
               var decorrido = agora - this.ultimoOvni;
               
               if (painel.pontuacao >= 500 && !nivel2Ativado) { //
                  nivel2Ativado = true; 
                  novoInimigoTanque(); 
               }
               
               if (this.ultimoUpVida == 0) this.ultimoUpVida = agora;
               if (agora - this.ultimoUpVida > 15000) { //
                   novoUpVida(); 
                   this.ultimoUpVida = agora; 
               }

               // --- CORREÇÃO: Chamava 'novoInimigo' ---
               if (decorrido > 1000) {
                  novoOvni(); //
                  this.ultimoOvni = agora;
               }
            }
         };
         animacao.novoProcessamento(criadorInimigos);
      }

      function novoOvni() {
         var imgOvni = imagens.ovni; 
         var ovni = new Ovni(context, imgOvni, imagens.explosao);
         ovni.velocidade = Math.floor(500 + Math.random() * (1000 - 500 + 1));
         ovni.x = Math.floor(Math.random() * (canvas.width - ovni.largura + 1));
         ovni.y = -ovni.altura;
         animacao.novoSprite(ovni);
         colisor.novoSprite(ovni);
      }
      
      function novoInimigoTanque() {
         var imgTanque = imagens.tanque; 
         var tanque = new InimigoTanque(context, imgTanque, imagens.explosao);
         tanque.x = (canvas.width / 2) - (tanque.largura / 2);
         tanque.y = -tanque.altura;
         animacao.novoSprite(tanque);
         colisor.novoSprite(tanque);
      }
      
      function novoUpVida() {
         var imgUpVida = imagens.upvida; 
         var upVida = new UpVida(context, imgUpVida);
         upVida.velocidade = 100;
         upVida.x = Math.floor(Math.random() * (canvas.width - imgUpVida.width + 1));
         upVida.y = -imgUpVida.height;
         animacao.novoSprite(upVida);
         colisor.novoSprite(upVida);
      }

      function pausarJogo() {
         if (animacao.ligado) {
            animacao.desligar();
            ativarTiro(false);
            musicaAcao.pause(); 
            context.save();
            context.fillStyle = 'rgba(0,0,0,0.5)'; 
            context.fillRect(0, 0, canvas.width, canvas.height);
            context.fillStyle = 'white';
            context.strokeStyle = 'black';
            context.font = '50px "Press Start 2P", monospace';
            context.textAlign = 'center';
            context.fillText("Pausado", canvas.width / 2, canvas.height / 2);
            context.strokeText("Pausado", canvas.width / 2, canvas.height / 2);
            context.restore();
         }
         else {
            criadorInimigos.ultimoOvni = new Date().getTime();
            animacao.ligar();
            ativarTiro(true);
            musicaAcao.play(); 
         }
      }

      function iniciarOpcoes() {
         gameState = 'info';
         limparSpritesDinamicos();
         
         // Cria a TelaInfo com o título e a imagem de controles
         var telaOpcoes = new TelaInfo(context, teclado, 
                                       'OPÇÕES', 
                                       imagens.controles, 
                                       null); // null = sem texto
         animacao.novoSprite(telaOpcoes);
      }
      
      function iniciarCreditos() {
         gameState = 'info';
         limparSpritesDinamicos(); 
         // Cria a TelaInfo com o título e as linhas de texto
         var creditosTextos = [
            'Devs: ', 
            '',
            'Joao Pedro Reis ',
            '',
            'Vinícius Rodrigues',
            '',
            'Obrigado por Jogar!'
         ];
         
         var telaCreditos = new TelaInfo(context, teclado, 
                                         'CRÉDITOS', 
                                         null, // null = sem imagem
                                         creditosTextos);
         animacao.novoSprite(telaCreditos);
      }
      function ativarTiro(ativar) {
         if (ativar) {
            teclado.disparou(ESPACO, function () {
               nave.atirar();
            });
         }
         else
            teclado.disparou(ESPACO, null);
      }
      // (Arquivo: index.html - SUBSTITUA a função 'gameOver' antiga)

      function gameOver() {
         gameState = 'gameover';
         
         // 1. Desliga controles
         ativarTiro(false);
         teclado.disparou(ENTER, null); 
         
         // 2. Troca música
         musicaAcao.pause();
         musicaAcao.currentTime = 0.0;
         musicaMenu.play(); 

         // 3. Salva a pontuação
         var pontuacaoFinal = 0;
         if (animacao.painel) {
            pontuacaoFinal = animacao.painel.pontuacao;
         }
         
         // 4. Limpa sprites e (IMPORTANTE) desliga o painel
         limparSpritesDinamicos();
         animacao.painel = null; // <-- Evita o bug da tela congelada
         
         // 5. Desenha o texto "GAME OVER"
         context.save();
         context.fillStyle = 'white';
         context.strokeStyle = 'black';
         context.font = '20px "Press Start 2P", monospace';
         context.textAlign = 'center'; 
         var yCentro = canvas.height / 2; 
         context.fillText("GAME", canvas.width / 2, yCentro - 80); 
         context.strokeText("GAME", canvas.width / 2, yCentro - 80);
         context.fillText("OVER", canvas.width / 2, yCentro);     
         context.strokeText("OVER", canvas.width / 2, yCentro);
         context.restore();

         // 6. Desenha a pontuação final
         context.save();
         context.fillStyle = 'white';
         context.font = '20px "Press Start 2P", monospace';
         var xPontuacao = 10 + (3 * 35); 
         var yPontuacao = 31; 
         context.fillText(pontuacaoFinal, xPontuacao, yPontuacao);
         context.restore();
         
         // 7. Reconfigura o menu principal
         menu.options = ['TENTAR NOVAMENTE', 'SAIR (MENU)'];
         menu.selected = 0;
         menu.y = yCentro + 100; // Move os botões para baixo
         
         // Sobrescreve a seleção
         menu.selecionar = function() {
            var op = this.options[this.selected];
            if (op === 'TENTAR NOVAMENTE') {
                iniciarPartida();
            } 
            else if (op === 'SAIR (MENU)') {
                iniciarMenu(); // Recria o menu original
            }
         };
         
         // 8. Adiciona o menu modificado
         animacao.novoSprite(menu);
         menu.configurarTeclado();
      }
   </script>
</body>
</html>